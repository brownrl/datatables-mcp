#!/usr/bin/env php
<?php

/**
 * DataTables MCP Server CLI
 * 
 * Commands:
 *   index - Scrape and index DataTables documentation
 *   serve - Run MCP server (stdio mode)
 *   search <query> - Test search functionality
 */

// Detect if running from vendor/bin (symlink) or package directly
$binFile = realpath($_SERVER['SCRIPT_FILENAME']);
$binDir = dirname($binFile);

if (basename($binDir) === 'bin' && basename(dirname($binDir)) !== 'vendor') {
    // Running directly from package: datatables-mcp/bin/datatables-mcp
    $packageRoot = dirname($binDir);
    $autoload = $packageRoot . '/vendor/autoload.php';
} else {
    // Running from vendor/bin/datatables-mcp or as dependency
    // Walk up to find vendor/autoload.php
    $packageRoot = $binDir;
    for ($i = 0; $i < 5; $i++) {
        if (file_exists($packageRoot . '/vendor/autoload.php')) {
            $autoload = $packageRoot . '/vendor/autoload.php';
            break;
        }
        if (file_exists($packageRoot . '/autoload.php') && basename($packageRoot) === 'vendor') {
            $autoload = $packageRoot . '/autoload.php';
            // Package is installed as dependency, find its root
            $packageRoot = $packageRoot . '/brownrl/datatables-mcp';
            break;
        }
        $packageRoot = dirname($packageRoot);
    }
}

if (!isset($autoload) || !file_exists($autoload)) {
    fwrite(STDERR, "Error: Could not find autoload.php\n");
    exit(1);
}

require_once $autoload;

use DataTablesMcp\McpServer;
use DataTablesMcp\SearchEngine;
use DataTablesMcp\DocumentationIndexer;

// Database path - always relative to package root
$dbPath = $packageRoot . '/data/datatables.db';

// Parse command
$command = $argv[1] ?? 'help';

switch ($command) {
    case 'index':
        echo "DataTables Documentation Indexer\n";
        echo "================================\n\n";
        
        try {
            $indexer = new DocumentationIndexer($dbPath);
            $indexer->indexAll();
        } catch (\Exception $e) {
            echo "Error: " . $e->getMessage() . "\n";
            exit(1);
        }
        break;

    case 'serve':
        // MCP server mode - communicates via stdio
        try {
            $searchEngine = new SearchEngine($dbPath);
            $server = new McpServer($searchEngine);
            $server->run();
        } catch (\Exception $e) {
            fwrite(STDERR, "Error: " . $e->getMessage() . "\n");
            exit(1);
        }
        break;

    case 'search':
        // Test search functionality
        $query = $argv[2] ?? '';
        
        if (empty($query)) {
            echo "Usage: php bin/datatables-mcp search <query>\n";
            exit(1);
        }

        try {
            $searchEngine = new SearchEngine($dbPath);
            $results = $searchEngine->search($query, 5);

            echo "Search results for: \"$query\"\n";
            echo str_repeat('=', 50) . "\n\n";

            if (empty($results)) {
                echo "No results found.\n";
            } else {
                foreach ($results as $i => $result) {
                    $num = $i + 1;
                    echo "[$num] {$result['title']}\n";
                    echo "    URL: {$result['url']}\n";
                    echo "    Type: {$result['doc_type']} | Section: {$result['section']}\n";
                    echo "    " . substr($result['content'], 0, 150) . "...\n\n";
                }
            }
        } catch (\Exception $e) {
            echo "Error: " . $e->getMessage() . "\n";
            exit(1);
        }
        break;

    case 'stats':
        // Show database statistics
        try {
            $searchEngine = new SearchEngine($dbPath);
            $stats = $searchEngine->getStats();
            $types = $searchEngine->getDocTypes();

            echo "Database Statistics\n";
            echo "==================\n\n";
            echo "Total documents: {$stats['total_docs']}\n";
            echo "Document types: {$stats['doc_types']}\n";
            echo "Sections: {$stats['sections']}\n\n";

            echo "Breakdown by type:\n";
            foreach ($types as $type) {
                echo "  {$type['doc_type']}: {$type['count']}\n";
            }
        } catch (\Exception $e) {
            echo "Error: " . $e->getMessage() . "\n";
            exit(1);
        }
        break;

    case 'parse-structured':
        try {
            $db = new PDO("sqlite:$dbPath");
            $db->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
            
            echo "Parsing structured data from stored HTML...\n";
            
            // Clear existing structured data
            $db->exec("DELETE FROM parameters");
            $db->exec("DELETE FROM code_examples");
            $db->exec("DELETE FROM related_items");
            $db->exec("DELETE FROM return_types");
            $db->exec("DELETE FROM notes_caveats");
            $db->exec("DELETE FROM value_types");
            
            echo "Cleared existing structured data\n";
            
            // Get all reference documents with HTML
            $stmt = $db->query("SELECT id, title, url, raw_html FROM documentation WHERE doc_type = 'reference' AND raw_html IS NOT NULL ORDER BY id");
            $docs = $stmt->fetchAll(PDO::FETCH_ASSOC);
            
            echo "Found " . count($docs) . " reference documents to parse\n\n";
            
            $parser = new DataTablesMcp\StructuredParser();
            $indexer = new DataTablesMcp\DocumentationIndexer($dbPath);
            
            $processed = 0;
            $withStructuredData = 0;
            
            foreach ($docs as $doc) {
                $processed++;
                
                if ($processed % 50 === 0) {
                    echo "Progress: $processed/" . count($docs) . " documents processed\n";
                }
                
                // Determine parser type based on URL
                if (strpos($doc['url'], '/reference/api/') !== false) {
                    $structured = $parser->parseApiPage($doc['raw_html']);
                } else {
                    $structured = $parser->parseOptionPage($doc['raw_html']);
                }
                
                // Check if we got any structured data
                $hasData = !empty($structured['parameters']) || 
                          !empty($structured['examples']) || 
                          !empty($structured['related']) ||
                          !empty($structured['value_types']);
                
                if ($hasData) {
                    $withStructuredData++;
                    // Store structured data using reflection to access private method
                    $reflection = new ReflectionClass($indexer);
                    $method = $reflection->getMethod('storeStructuredData');
                    $method->setAccessible(true);
                    $method->invoke($indexer, $doc['id'], $structured);
                }
            }
            
            echo "\nParsing complete!\n";
            echo "Documents processed: $processed\n";
            echo "With structured data: $withStructuredData\n\n";
            
            // Show statistics
            $stats = [
                'parameters' => $db->query("SELECT COUNT(*) FROM parameters")->fetchColumn(),
                'code_examples' => $db->query("SELECT COUNT(*) FROM code_examples")->fetchColumn(),
                'related_items' => $db->query("SELECT COUNT(*) FROM related_items")->fetchColumn(),
                'return_types' => $db->query("SELECT COUNT(*) FROM return_types")->fetchColumn(),
                'value_types' => $db->query("SELECT COUNT(*) FROM value_types")->fetchColumn(),
                'notes' => $db->query("SELECT COUNT(*) FROM notes_caveats")->fetchColumn(),
            ];
            
            echo "Structured data statistics:\n";
            foreach ($stats as $table => $count) {
                echo "  $table: $count\n";
            }
            
        } catch (\Exception $e) {
            echo "Error: " . $e->getMessage() . "\n";
            exit(1);
        }
        break;

    case 'help':
    default:
        echo "DataTables MCP Server\n";
        echo "====================\n\n";
        echo "Commands:\n";
        echo "  index            - Scrape and index DataTables documentation\n";
        echo "  parse-structured - Parse structured data from stored HTML\n";
        echo "  serve            - Run MCP server (stdio mode)\n";
        echo "  search <query>   - Test search functionality\n";
        echo "  stats            - Show database statistics\n";
        echo "  help             - Show this help message\n\n";
        echo "Examples:\n";
        echo "  php bin/datatables-mcp index\n";
        echo "  php bin/datatables-mcp parse-structured\n";
        echo "  php bin/datatables-mcp serve\n";
        echo "  php bin/datatables-mcp search \"ajax options\"\n";
        echo "  php bin/datatables-mcp stats\n\n";
        break;
}
